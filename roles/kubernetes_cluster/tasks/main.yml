- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true

- name: Install required packages
  ansible.builtin.apt:
    name:
      - curl
      - apt-transport-https
      - software-properties-common
      - ca-certificates
      - gnupg2
    state: present

- name: Install Docker
  ansible.builtin.apt:
    name: docker.io
    state: present

- name: Enable and start Docker
  ansible.builtin.service:
    name: docker
    enabled: true
    state: started

- name: Download Kubernetes GPG key securely
  ansible.builtin.shell: >
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key |
    sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add Kubernetes repository
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/kubernetes.list
    line: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /"
    create: true
    state: present
    mode: '0644'

- name: Install Kubernetes components
  ansible.builtin.apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present
    update_cache: true

- name: Enable and start kubelet
  ansible.builtin.service:
    name: kubelet
    enabled: true
    state: started

- name: Include master specific tasks
  ansible.builtin.include_tasks: master.yml
  when: "'master' in group_names"
